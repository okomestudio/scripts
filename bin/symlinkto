#!/usr/bin/env bash

target_tree="$SYMLINKTO_TREE"

if [ -z "$target_tree" ]; then
  echo "Set SYMLINKTO_TREE before using symlinkto"
  exit 1
fi

# DO NOT CHANGE BELOW

here=$(pwd)
here="${here/#\~/$HOME}"

target_tree="${target_tree/#\~/$HOME}"

for target in $(tree -afiF --prune --noreport "$here"); do
  if [ -f "$target" ]; then
    echo "Target found: $target"

    link="$HOME/${target/$target_tree/}"
    link_parent="$(dirname $link)"
    if [ -L "$link" ]; then
      echo "Link found: $link"
    elif [ -e "$link" ]; then
      echo "File exists: $link"
    elif [ ! -d "$link_parent" ]; then
      echo "Link parent directory does not exist: $link_parent"
    else
      echo "Link is missing: $link"
      read -p 'Create? [y/N]: ' resp
      resp=${resp:-n}
      if [ $resp = "Y" ] || [ $resp = "y" ]; then
        ln -s "$target" "$link"
        echo "Link created: $link"
      else
        echo "Link skipped: $link"
      fi
    fi
  fi
done
